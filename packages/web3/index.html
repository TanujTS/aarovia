<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>MetaMask Connect Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      button {
        background: #4CAF50;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
      }
      button:hover {
        background: #45a049;
      }
      #results {
        margin-top: 20px;
        font-family: monospace;
        background: #f5f5f5;
        padding: 15px;
        border-radius: 5px;
      }
      textarea {
        width: 100%;
        height: 120px;
        font-family: monospace;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <h1>üîó MetaMask Wallet Connect Test</h1>
    <button id="connectButton">Connect Wallet</button>
    <div id="status" style="margin-top: 10px; color: #666;"></div>
    <div id="results"></div>

    <script>
      async function connectWallet() {
        const statusDiv = document.getElementById('status');
        const resultsDiv = document.getElementById('results');
        
        console.log(' Connect wallet clicked!');
        statusDiv.innerHTML = 'Checking for MetaMask...';
        
        //clear previous results
        resultsDiv.innerHTML = '';
        
        if (typeof window.ethereum !== 'undefined' && window.ethereum.isMetaMask) {
          console.log('MetaMask detected!');
          try {
            statusDiv.innerHTML = 'Requesting account access...';
            console.log('Requesting eth_requestAccounts...');


            const accounts = await window.ethereum.request({
              method: "eth_requestAccounts",
            });
            console.log("Connected:", accounts[0]);

            statusDiv.innerHTML = 'üîÑ Getting network info...';

            // üîπ Get network ID using direct ethereum request
            const networkId = await window.ethereum.request({
              method: 'net_version'
            });
            console.log("Network ID:", networkId);

            const walletAddress = accounts[0];
            console.log("Wallet Address:", walletAddress);

            statusDiv.innerHTML = '‚úçÔ∏è Please sign the message in MetaMask...';

            const message = "Sign this message to authenticate with Aarovia Medical Records";
            
            const signature = await window.ethereum.request({
              method: "personal_sign",
              params: [message, walletAddress],
            });
            console.log("Signature:", signature);

            statusDiv.innerHTML = 'Successfully connected and signed!';

            const loginData = {
              address: walletAddress,
              signature: signature,
              message: message
            };
            console.log("Login Data for API:", loginData);

            resultsDiv.innerHTML = `
              <h3>Connected Successfully!</h3>
              <p><strong>Address:</strong> <code>${walletAddress}</code></p>
              <p><strong>Network ID:</strong> ${networkId}</p>
              <p><strong>Message:</strong> <em>"${message}"</em></p>
              <p><strong>Signature:</strong> <code>${signature.substring(0, 30)}...${signature.substring(signature.length-10)}</code></p>
              <h4> Copy this JSON for Postman:</h4>
              <textarea readonly onclick="this.select()">${JSON.stringify(loginData, null, 2)}</textarea>
              <br><br>
              <button onclick="testAPI()" style="background: #2196F3;">üî¨ Test API Login</button>
            `;

            window.loginData = loginData;

          } catch (err) {
            console.error("Error:", err);
            statusDiv.innerHTML = ' Error: ' + err.message;
            resultsDiv.innerHTML = `
              <div style="color: red;">
                <h3> Connection Failed</h3>
                <p><strong>Error:</strong> ${err.message}</p>
                <p><strong>Troubleshooting:</strong></p>
                <ul>
                  <li>Make sure MetaMask is installed and unlocked</li>
                  <li>Refresh the page and try again</li>
                  <li>Check browser console for detailed errors</li>
                </ul>
              </div>
            `;
          }
        } else {
          console.log('‚ùå MetaMask not found or not enabled');
          console.log('window.ethereum:', typeof window.ethereum);
          console.log('window.ethereum.isMetaMask:', window.ethereum?.isMetaMask);
          
          statusDiv.innerHTML = '‚ùå MetaMask not detected';
          resultsDiv.innerHTML = `
            <div style="color: red;">
              <h3>‚ùå MetaMask Not Found</h3>
              <p><strong>Troubleshooting Steps:</strong></p>
              <ol>
                <li>Install MetaMask: <a href="https://metamask.io/download/" target="_blank">Download MetaMask</a></li>
                <li>Make sure MetaMask is enabled in your browser extensions</li>
                <li>Refresh this page after installing</li>
                <li>Try a different browser (Chrome/Firefox/Edge)</li>
                <li>Check browser console for detailed error messages</li>
              </ol>
              <p><small>Debug info: ethereum=${typeof window.ethereum}, isMetaMask=${window.ethereum?.isMetaMask}</small></p>
            </div>
          `;
        }
      }

      async function testAPI() {
        if (!window.loginData) {
          alert('Please connect wallet first!');
          return;
        }

        const statusDiv = document.getElementById('status');
        statusDiv.innerHTML = 'üîÑ Testing API login...';

        try {
          const response = await fetch('http://localhost:3002/api/auth/login', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(window.loginData)
          });

          const result = await response.json();
          console.log("API Response:", result);

          if (response.ok) {
            statusDiv.innerHTML = ' API login successful!';
            document.getElementById('results').innerHTML += `
              <div style="background: #e8f5e8; padding: 10px; margin-top: 10px; border-radius: 5px;">
                <h4>üéâ API Login Success!</h4>
                <pre>${JSON.stringify(result, null, 2)}</pre>
              </div>
            `;
          } else {
            throw new Error(result.message || 'API login failed');
          }
        } catch (err) {
          statusDiv.innerHTML = ' API test failed: ' + err.message;
          document.getElementById('results').innerHTML += `
            <div style="background: #ffe8e8; padding: 10px; margin-top: 10px; border-radius: 5px;">
              <h4> API Error</h4>
              <p>${err.message}</p>
              <p><small>Make sure your API server is running on http://localhost:3002</small></p>
            </div>
          `;
        }
      }

      function checkMetaMaskStatus() {
        const statusDiv = document.getElementById('status');
        
        if (typeof window.ethereum !== 'undefined') {
          if (window.ethereum.isMetaMask) {
            statusDiv.innerHTML = '‚úÖ MetaMask detected! Click "Connect Wallet" to continue.';
            console.log('‚úÖ MetaMask is available and ready');
          } else {
            statusDiv.innerHTML = '‚ö†Ô∏è Ethereum provider detected but not MetaMask';
            console.log('‚ö†Ô∏è Ethereum provider found but isMetaMask is false');
          }
        } else {
          statusDiv.innerHTML = '‚ùå MetaMask not found. Please install MetaMask extension.';
          console.log('‚ùå No ethereum provider found');
        }
      }

      document.addEventListener('DOMContentLoaded', function() {
        document.getElementById("connectButton").addEventListener("click", connectWallet);
        
        // Check MetaMask status when page loads
        setTimeout(checkMetaMaskStatus, 1000); // Wait 1 second for MetaMask to load
      });
    </script>
  </body>
</html>
